---
title       : Project Write-Up
subtitle    : 
author      : Giovanni Fossati
job         : Rice University
output      : 
  html_document:
    self_contained: false
    theme: cerulean
    highlight: tango
    css: gf_small_touches.css
---

```{r setup, cache = FALSE, echo = FALSE, message = FALSE, warning = FALSE, tidy = FALSE}
require(knitr)
# make this an external chunk that can be included in any file
options(width = 100)
opts_chunk$set(message = FALSE, error = FALSE, warning = FALSE, collapse = TRUE, fig.align = 'left', dpi = 100, tidy = FALSE, cache.path = '.cache/', fig.path = 'figures/')

# options(xtable.type = 'html')
# knit_hooks$set(inline = function(x) {
#   if(is.numeric(x)) {
#     round(x, getOption('digits'))
#   } else {
#     paste(as.character(x), collapse = ', ')
#   }
# })
# knit_hooks$set(plot = knitr:::hook_plot_html)
```

```{r load_packages, cache = FALSE, echo = FALSE, message = FALSE, warning = FALSE, tidy = FALSE}
require(plyr)
#
require(ggplot2)
require(gtable)
require(gridExtra)
require(corrplot)
require(rattle)
#
require(caret)
require(randomForest)
require(partykit)
require(gbm)
require(rpart)
#
require(pROC)
#
# require(foreach)
# require(doMC)
```

```{r my_defs, echo=FALSE}
tidy_df <- function( data ) {
    for(i in 8:159) { 
        data[,i] <- as.numeric(data[,i])
    }
    colnames(data) <- gsub("_picth", "_pitch", colnames(data), perl=TRUE)
    colnames(data) <- gsub("var_total_accel_", "var_accel_", colnames(data), perl=TRUE)
    colnames(data) <- gsub("roll_belt.1", "pitch_belt", colnames(data), perl=TRUE)
    return(data)
}

add_new_variables <- function( data ) { 
    data$classe <- as.factor(data$classe)
    data$timestamp <- data$raw_timestamp_part_1 + data$raw_timestamp_part_2
    data$date <- strptime(as.character(data$cvtd_timestamp), "%d/%m/%Y %H:%M")
    return(data)
}

select_proper_vars <- function( data ) {
    vec0 <- c("total_accel", "var_accel")
    
    nn1 <- c("avg", "stddev", "var", "kurtosis", "skewness", "min", "max", "amplitude")
    vec1 <- c("roll", paste(nn1, "roll", sep="_"), 
              "pitch", paste(nn1, "pitch", sep="_"), 
              "yaw", paste(nn1, "yaw", sep="_"))
    
    nn2 <- c("gyros", "accel", "magnet")
    vec2 <- paste( rep(nn2, each=3), "VVV", c("x","y","z"), sep="_")
    
    vec.VVV <- c(paste(c("total_accel", "var_accel", vec1), "VVV", sep="_"), vec2)
    vec.belt <- gsub("_VVV", "_belt", vec.VVV, perl=TRUE)
    vec.arm <- gsub("_VVV", "_arm", vec.VVV, perl=TRUE)
    vec.forearm <- gsub("_VVV", "_forearm", vec.VVV, perl=TRUE)
    vec.dumbbell <- gsub("_VVV", "_dumbbell", vec.VVV, perl=TRUE)
    i.classe <- which( colnames(data) == "classe")
    
    if( length(i.classe) > 0 ) {
        select <- data[, c("classe", vec.belt, vec.arm, vec.forearm, vec.dumbbell)]
    } else {
        select <- data[, c("problem_id", vec.belt, vec.arm, vec.forearm, vec.dumbbell)]
    }
    return(select)
}

# define color palettes
color1 <- colorRampPalette(c("#7F0000", "red", "#FF7F00", "yellow", "white", "cyan", "#007FFF", "blue", "#00007F"))
color2 <- colorRampPalette(c("#67001F", "#B2182B", "#D6604D", "#F4A582", "#FDDBC7",
                           "#FFFFFF", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"))	
color3 <- colorRampPalette(c("red", "white", "blue"))	

# correct answers
answers <- c("B", "A", "B", "A", "A", "E", "D", "B", "A", "A", "B", "C", "B", "A", "E", "E", "A", "B", "B", "B")
```

The choice of a random forest as an ensemble method is due to its ability to handle multi-class
problems and its overall competitive performance.

---

## THE DATA SET

### Structure

The dataset comprises 160 variables:

* 152 actual _predictors_, _i.e._ the sensor data.
* 1 is the quality _class_ of the exercise (`classe`, taking values _A_, _B_, _C_, _D_, _E_).
* 7 are auxiliary variables: 
	* the _user_ name (`user_name`).
	* 3 time stamp related variables: `raw_timestamp_part_1`, `raw_timestamp_part_2`, `cvtd_timestamp`.
	* 2 _exercise window_ markers/counters: `new_window`, `num_window`.

### The sensor data

As described in the paper by Velloso et al. [REF], four _inertial measurement units_ (IMU) where setup, placed  
on _belt_, _arm_, _forearm_, _dumbbell_.
Each sensor measured 3-axes acceleration, gyroscope and magnetometer data at high cadence (45 Hz).
These data were processed to yield 13 timed variables for each sensor: 

* _total acceleration_.
* _roll_, _pitch_, _yaw_ angles.
* _x_, _y_, _z_ values for _gyroscope_, _acceleleration_, and _magnetometer_. 

For instance, for the _belt_ sensor the _basic timed data_ are: 
`total_accel_belt`, 
`roll_belt`, `pitch_belt`, `yaw_belt`, 
`gyros_belt_x`, `gyros_belt_y`, `gyros_belt_z`, 
`accel_belt_x`, `accel_belt_y`, `accel_belt_z`, 
`magnet_belt_x`, `magnet_belt_y`, `magnet_belt_z`.

The dataset therefore comprises $4 \times 13 = 52$ _basic timed data_.

In addition to these, several statistical summaries are computed and reported for each exercise _window_, for each sensor:

* For `total_accel`, its variance `var_accel`.
* For each of the three angles: `avg`, `stddev`, `var`, `kurtosis`, `skewness`, `max`, `min`, `amplitude` ($3 \times 8$ variables).

These $1 + 24 = 25$ statistical summaries for each sensor add another $100$ variables to the dataset for a total of $152$ variables.

It is worth emphasizing that the dataset presents _timed_ and _summary_ variables all together in one table.
While this may be practically convenient, it makes this dataset _un-tidy_ by combining variables of different nature.
Fortunately the two types of variables can be easily separated on the basis of the value of the `new_window` auxiliary variable,
which has value `no` for entries corresponding to timed data, and `yes` for their statistical summaries over each exercise window.


---

## DATA PREPARATION

### Loading

```{r load_training_dataset}
full <- read.csv("./pml-training.csv", na.strings=c("#DIV/0!","","NA"), stringsAsFactors=FALSE)
full <- add_new_variables(full)
alt.full <- tidy_df(full)
```

```{r load_TEST_dataset}
TEST <- read.csv("./pml-testing.csv", na.strings=c("#DIV/0!","","NA"), stringsAsFactors=FALSE)
alt.TEST <- tidy_df(TEST)
```

### Cleaning/Tidying

Some variables should be discarded because associated with very specific aspects of the 
experiment that should be irrelevant from the point of view of its goal, such as _window_ flags 
and _time stamps_.  
These are the excluded variables:  `X`,  `user_name`,  `new_window`,  `num_window`, 
`cvtd_timestamp`,  `raw_timestamp_part_1`,  `raw_timestamp_part_2`.

Beside their intrinsic irrelevance, keeping these in would likely strongly drive the results 
in a completely spurious and meaningless way, because for instance the algorithm may hook on the
`user_name` or `num_window`.

```{r clean_data}
alt.full <- subset(alt.full, new_window == "no")
alt.full.good <- select_proper_vars(alt.full)
alt.TEST.good <- select_proper_vars(alt.TEST)
alt.user <- alt.full$user_name
```


### Individual measurements and _summaries_ : the `new_window` variable

To the best of my understanding, the dataset combines two different kinds of _observations_:

* single measurements of the main observables from the sensors, with some time cadence, and 
organized in _windows_, which are numbered (`num_window` variable).   
These data have `new_window == "no"`.
* statistical summaries of the measurements of each main observable over each _window_.   
These data have `new_window == "yes"`, and 

```{r data_stats}
# columns without ANY NA
alt.tt <- colSums(is.na(alt.full.good)) == 0

alt.full.select <- alt.full.good[, alt.tt]
alt.TEST.select <- alt.TEST.good[, alt.tt]

# alt.full.noNA <- alt.full.good[, alt.tt]
# alt.TEST.noNA <- alt.TEST.good[, alt.tt]
# alt.full.select <- alt.full.noNA
# alt.TEST.select <- alt.TEST.noNA
```

```{r cleaning-1, echo=FALSE}
rm(alt.tt, alt.full.noNA, alt.TEST.noNA)
```

### Some exploratory plots

```{r plots-examine2a, fig.width=6, fig.height=6}
df <- alt.full
#   8 = roll_belt
#   9 = pitch_belt
#  10 = yaw_belt
#  46 = roll_arm
# 122 = roll_forearm
ii <- 8

p1 <- ggplot(df, aes(1:nrow(df), df[, ii])) + theme_bw() + geom_point(aes(col=user_name)) + theme(legend.position = "top") + ylab(colnames(df)[ii]) + ggtitle(colnames(df)[ii]) 
p2 <- ggplot(df, aes(1:nrow(df), df[, ii])) + theme_bw() + geom_point(aes(col=classe)) + theme(legend.position = "bottom") + ylab(colnames(df)[ii]) 
grid.arrange(p1, p2, nrow=2)
```

```{r plots-examine2b, fig.width=6, fig.height=6}
df <- alt.full
#   8 = roll_belt
#   9 = pitch_belt
#  10 = yaw_belt
#  46 = roll_arm
# 122 = roll_forearm
ii <- 46

title_string <- paste(colnames(df)[ii], "by user and classe", sep=" ")
p1 <- ggplot(df, aes(1:nrow(df), df[, ii])) + theme_bw() + geom_point(aes(col=user_name)) + theme(legend.position = "top") 
p1 <- p1 + ylab(colnames(df)[ii]) + ggtitle(title_string)
p2 <- ggplot(df, aes(1:nrow(df), df[, ii])) + theme_bw() + geom_point(aes(col=classe)) + theme(legend.position = "bottom") 
p2 <- p2 + ylab(colnames(df)[ii]) 
# p1 <- ggplot(df, aes(1:nrow(df), df[, ii])) + theme_bw() + geom_point(aes(col=user_name)) + theme(legend.position = "top") + ylab(colnames(df)[ii]) + ggtitle(colnames(df)[ii]) 
# p2 <- ggplot(df, aes(1:nrow(df), df[, ii])) + theme_bw() + geom_point(aes(col=classe)) + theme(legend.position = "bottom") + ylab(colnames(df)[ii]) 
grid.arrange(p1, p2, nrow=2)
```

```{r plots-examine2c, fig.width=6, fig.height=6}
df <- alt.full
#   8 = roll_belt
#   9 = pitch_belt
#  10 = yaw_belt
#  46 = roll_arm
# 122 = roll_forearm
ii <- 9

title_string <- paste(colnames(df)[ii], "by user and classe", sep=" ")
p1 <- ggplot(df, aes(1:nrow(df), df[, ii])) + theme_bw() + geom_point(aes(col=user_name)) + theme(legend.position = "top") 
p1 <- p1 + ylab(colnames(df)[ii]) + ggtitle(title_string)
p2 <- ggplot(df, aes(1:nrow(df), df[, ii])) + theme_bw() + geom_point(aes(col=classe)) + theme(legend.position = "bottom") 
p2 <- p2 + ylab(colnames(df)[ii]) 
grid.arrange(p1, p2, nrow=2)
```


```{r plots-more_1, fig.width=6, fig.height=6}
df <- alt.full.select 
p <- ggplot(df, aes(pitch_arm, roll_arm)) + theme_bw() + geom_point(aes(col=classe)) + ggtitle("pitch_arm vs. roll_arm by classe")
p + facet_grid(classe ~ .)
```

```{r plots-more_2, fig.width=6, fig.height=6}
df <- alt.full.select 
p <- ggplot(df, aes(pitch_forearm, roll_forearm)) + theme_bw() + geom_point(aes(col=classe)) + ggtitle("pitch_forearm vs. roll_forearm by classe")
p + facet_grid(classe ~ .)
```

